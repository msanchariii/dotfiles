---
- name: play
  hosts: localhost
  vars_files: 
    - credentials.yml
  tasks:


## Git configuration
    - name: "Git | Set user.email"
      community.general.git_config:
        name: user.email
        scope: global
        value:  !vault |
          $ANSIBLE_VAULT;1.1;AES256
          61316532313262376330363766626639376133373432323863383663376562646637363061653331
          3738346136303339326130323934316531333464646334650a346463363431323562383965366232
          65336534356630303063626265663965666130306465373136303031616438613538363762356338
          3331306234643536630a653439326530303931396535333662383466633439626435613434306363
          33386661353633316335376634353861646436613864363531366365333131323737
      no_log: false
      tags:
        - mac-minimal
        - mac-full
        - linux

    - name: "Git | Set user.name"
      community.general.git_config:
        name: user.name
        scope: global
        value: "{{ git_user_name }}"
      no_log: true
      tags:
        - mac-minimal
        - mac-full
        - linux

    - name: Create .ssh directory
      file:
        path: "{{ ansible_user_dir }}/.ssh"
        state: directory
        mode: '0700'
      tags:
        - mac-minimal
        - mac-full
        - linux

    - name: "SSH | Copy SSH keys"
      copy:
        dest: "{{ ansible_user_dir }}/.ssh/personal_rsa"
        content: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          35393134653739366637653038623432333237623336613633323936653538363134643161316139
          3134353332613131646230623162623361666534393163350a326337306438333433663561363033
          64646238383838633238616466653533643930306464333663633034663861316562343863633366
          3564663230326462350a656361656266383635653533656538666263633930353937393564373563
          63323066363430636138613538623831356665623764333732373536323165373733343562316461
          30333536366536366465653463643962643833323437653333313363306138393637636333396337
          65393230646366613336333065653534333637333236306536303934653632633634383665323661
          37353765383465333839656564333465396466396464353065646236376662643062326565313863
          36313032653030373037313733306363383334326433313663306135613162643036386236386638
          64373363393162363737613539613062383864336131616235633039323663383939373536656237
          38643163346435376331313832646165623637323130356635623733333464333439323061353134
          30643761396437343731656239383764373434353732636435336463313866326466366163333837
          32363765333837623562373135646534393562306236393238386165663764343963323537343034
          33643030333762616130336335323131306136333133663938613531633438323161633337343263
          30333830343764383930656262636138363637353438613366313561313537626162623265303534
          33636464333764373662613238613464633733613834386637633066653361653764346434316137
          38613338323335323934333865636562633837383563313365373261306531336165613135303132
          38623635653239623063366330636431336637323764313034626536643033356166376530613661
          33623435343931383434313464643933333239643535336335396665346134353664373632653866
          32306332303635376132313930626132313934386566626462613139306237353638353532613563
          31393164393932613361643866333265383335656439343163616237326634343837386630316262
          61383366653135393730353033303231356332336165663939643664663063656436326131643438
          30666333343931653966643063623837353031386630393635626132323530336436666436653763
          64376433666238366338663532346331306361383161373733306262323333383639666331353331
          63383133316539366636303264646661656334363537373635383261383437396431363765616630
          61386435383564303832666236666430316639353363353931346638363065643230353665636662
          61323432393534323561373065653233393461656364396665396430663132656663353163636434
          36666465633134393334366566303561343631386331396232366166373366346263343538626231
          36653062613932643563626535313363303239303037316337393361383137346130623564376336
          62346664633866613035343263333631613030356334306461363737633739306165633537656335
          66383333346435333662613838646232393562373664366430363435373935376236316563613738
          61306230616339666634353533323335623162386630623435656432333238616539623132613665
          30626262333465313663373466343038346366393339636133626530353632623434613730363535
          66353862643061353066353732316137663134333735383032373932343536356635306232396662
          30373761623730616661646237313161663030643232663834643031343661363231386165303461
          32653764643839613933343761363265633430383837636435396263613161346136356164663566
          61343535373766613034353639363135653235383366316136643332316131393265376236393432
          30336662396266393935386238656664623634643164393064393366343361363861393138366365
          34663134623936306337396234383936393030386430653861643131386464646439313966303864
          35636433336132326236663732626132383063626661393430663861303532356462633231393064
          34303564356464366363643463373532306335623933626166373030316230386233363335326464
          33393963313864356635626262663034393966353835346636333137633230663930666533613337
          37303533326531653738356333666561323563656533613632313766373163373339353561653832
          65396165323766376665613735336263623066316662383566633632313963376537643036353237
          61376239663933616166386564373031626539316665396237653337353138346239316138643838
          33623634633537353336303735336662616363643135306362316637613437383864343934386266
          66313235333461303166383136333935336566336664643434326532376534646665313966656532
          64373761363838306638323734383362316366626434356462646133386537383361666433666334
          62383665393365363132363162653935653432333831356633393737343638613762336636623166
          63316631373063643838666263366238616436646265316463336530343063613336616439333161
          65646130366363633439626333663033643961323932353161636536383936636136306666346461
          63313633383263643064393938353337373735316535343962313836393566373434336238383835
          65646665633866663930316236643334666436653939343831326361373535323266343462383434
          62663430303737373765643830313764666466353134343761613666643061363138386234666664
          33336430303632356537396632353264356165353532663833313765356538343038643964316366
          36353236396436353033343330373530613166663066373730313064383137333439366139396565
          38303861663837353231356433633439316537663431666166623439623336303637323763626565
          62326131623136666631383362303763663432643662343037323834636639663239636531623536
          62363736633964616261343561633032646535663064306665366466313862373732336431616566
          33373662336636346231663961653935393736613436616561363961303330366530663934303662
          64323837346265636431316231323062653837363166316363326562613832326135626532306561
          36646135313939663535306130386133303038623936353237363434346136356535386664646430
          35336238663765636435353761393535356264323262396261313033376563366533393237626165
          34376332363163303837393135326639363161386164343134303939313766313031363565393664
          62646361653764633531633434373434636162626466303134666131356230626462633865393364
          62306166383363633036353233333533363566656463623434303433336539356537383666303737
          66633236393534333363336537616163613738343334323266323837313431633432386134313264
          34643737323533333763363862656330636662623035376332653539383065613631366134303430
          64633932376236353965356533646633613365653134396533383037626534623438646166663030
          66323134643130303661343065336433653533333634313035353361343162306335336235656536
          34326539363363663632346439643032363261353062373238363434393037663639303663643361
          31663766623334653439353938656338356461346639376234653731663536616465333236386331
          35303833353263333937383166373730643566316437653931613861343339303362306263643230
          66306131323432613530346634343464616261663261346566626237326131303630396630663062
          38663234633430633034353536393563623734663334393435366139623565376639663932623761
          62343033373063346539663730633565303761383739663539313237613033323931613465653538
          32653333323337356331613564663664653337326535646630366231303462313137303236626233
          37396532363362303736366631363264393663343935633437323666303561343164313430323034
          33333564633838323331313231353462353266383931633632633662653730326334656439333839
          64663363303064663635616639323030373164613564373533306364323634373537666235623631
          64653530333631386232306630376461666231633730363762613566613837636134316238363533
          39306639303161356264303938626134613637343837316164656361616561393430393836653130
          35656134663239303932633063333131643361666264323762343863346664363161663262656231
          61376165646266626637656361373939376466353361373166643364633930363835333434346630
          64636364366339326264633436616235363465386435313433623466343666663261643961613166
          63343438643761626537666432313333323434666531613864356263333334323964356663363865
          61663238663434383431343636393266316632336361613133343837363137306433386364623337
          30666332633462666434306434646265653834336336333530316332653763303636613464303462
          38366331336630623735333535376561623239373733306661373938333036616232646566666633
          33396532323863623364623937346634646430356639363930336439653934373837363836613633
          39383033363662396335666631343864373430323739343764386634663031386261613764663761
          30383930323939356564343365326663366264616461313533663530643030313461643566356432
          33623461643330323136663430326135626637306238663736336161373731356138626635663363
          30313363656366313833393634356161646161323539373638613766306534656262353636356133
          63303032663439333765623532386332313766393038316430383363353331343561323133336161
          62616332336234306133386234333363303733363335376662336334363466626133326230643231
          35653966613563306164666661323238356131313261363035376134643535383634363136373334
          61326435393865333164386630323238346465626264613663383162363139326364623032366636
          38653965636264636232363262663138376434373561373036633863393362656166316639373839
          64383164613134633134646133333834386365616337633764353065646235396361303836623631
          30336338643435333836376630353233666166333365626363643234643262653231633631373736
          37323933613138636530616630663262646137303333636637323966313039613934366265633831
          37333037366530636436383530373161613466303030323436313430343930376538306133316633
          39386239306430626233363664363563313766386235323937316163393434353535626361653236
          32383366626230323665656461653032323465376561363135663866653338623830643938303233
          39623962373762663263326338633165653865666538363135303261333138333737626437646566
          61353864393837666535353264336538353665373638626538636465393237643263383931373933
          32646435623638663437323461356362363361303361333461333834356563376464633134363434
          31633038353031316139383830373065326138313638643034646565363035383466353762303561
          37393130653962633136633135343734666162666533373130313033313136623634396332616465
          39373863613366396262373963633566303235386263393634613731323138396636316430633366
          62343230313634333861333163636131323661613566353931303439396638323664363734623666
          63653233656236633561626438356465616339626235333139616633623462613831663039656637
          36356165633338643863396566363335646132353330306465326630333135366330383866376334
          64363038666162656462633338343564353463333335666338643234616531386431313531623330
          36343164313439393037626534363532386533353161336536646130646530303637303765303339
          38303864396466343865353462386530623135653537373664643864303038616262653932373033
          33396235646433373563616339333533356261376631363330633662356265306632373464623339
          65323038653837313634316264383361313639646235386363386666336139313138333539353030
          36376634313364326165373530623131363465376563323230663730643238373032393665376237
          39616662313433386334613936623132366666353133333761313736636165356366356138326532
          35316666373366626438366565386539323934393137646634366637373162376262653234306534
          32383337663433316135316262323731313838663736643165373933643135393263313333613365
          35396435386231373962396565303832303835376634376332323235303163326363323462666236
          66323337343264373432323837613563613939633238396430393037396237383038643736663938
          63396334613939643664636134386637336464336562303336393665383833386339383032303737
          61666337663766333865363731333666316637376637333836353734623634653639373464343430
          33643235333864383437356535393664656162336339636330386633613264353433393736613137
          62633739303637393031656233623662616561373737343761386339383666643433613839343735
          30636464383537313631363930363834343330653337623238343236386636356537653163666236
          62303033356636303062316464616431383138323930633732343639643361383638303664646264
          36313136393630323535376262343965306135393334326232613530643236356561366439326432
          35383238656338653863303033373063633939353633383232643766613734623333303438613938
          62393036616532626232346331376334643164353732656665313032613163643934303230396138
          64386436316434393135363636663631653363333735366538613938653634356432643931656439
          61653962626435386434653965313234376664343538306365623231656231623266373462303964
          62623864633164653534663630653539326630616635613436303931306135643439323165626438
          39396530623666373433633238383465356333366661373362366664663539383834336237646663
          65326436313362336363336232333966633363313836666335626134653366396533613461383065
          37303061333238343133653035383937653333666464613165373433623363643163613936366230
          31653035313231336265626466303134306538363839373563323236353031313235643432323766
          33386232336464633265653733323863386462343665336665363966353636313364613131313238
          36633938613765356131326134343537336131663235323930383761336430653061383131613432
          66616630656433363734393933643139623261393738396239353934376638643130396665613239
          31656361303135633036366334393165646333333834643363306630326462663236623335353534
          61663838353963656264373363613365613361623333616230303164616662623631306531653937
          34306661633434316461643663323861636362656130396261393062366331336463646664663932
          36396131303531326262363762356438303934646438646235336362386330616232356266353561
          30663434326236343830663563346365386662633236383532303038343032343262363363643232
          35613630613962353739393563666636333064306662666461366137356234363037653963653837
          66373139363061363366393437333937383434306536316461343664656365316633306266393065
          34393839396462616436653161366435376337613764383234346239363666333262333431616332
          34653863386234653265376538623232316133353863666466353331303762336662616236303939
          34323831643334366265643061386261386439333834333530613261653161616439356363613962
          66656632386230396534666163363632373135616531653266393237326634383630396561303036
          61623634636138393865326130303237363033306435363436333363393265663834366364626333
          64386262666263303337363233383432373230393161616665326637353837313137366263303038
          62613936323662323966396637376339616235626562343837656232313064383036366337303161
          63636534303639353063343439333564313264626235306466313639646464666266333535306539
          64663664666235386664383830353765653066373361323062353137393131663434613864323135
          33353963636432613736383261313466353062313530336231393839663331643735623866643938
          66663665646431326235633965306232313466323436323663633761376137646561346266333537
          30623338633837366232303339313261626633323064663132663761666663663033646463326438
          39633430393832646639376237393263636335346161313661323664613639343238363835373031
          30633461373034306664663634633465633362343936663162356431393061366539663434616131
          65336163346466636135353836623265656331336263316234393064653065396234376239316262
          37366361336564663765353637623962376564623836333832626436353730353833306338316239
          63393963383136613238346463643336373862336336383037396363643534653738653131643339
          62623236656130336233396236356261353866313633373230383938373462303532666430393562
          38323534333762333735386132623762386635356562613164346132613136316636346133313136
          38633937373134376331316564323036633130353536353064303734613766356265653937633032
          34666332323539313830363033386238376233326562616530663833373836616265646233336463
          35633433383239373038643631316536613734393233376262363930653931616534633536313230
          31363235666465363433633535663432646334666561356535396637303966313166366234666435
          64313737663633623961646464313834616335316434323137393332306636646163313235353066
          39373533346163623737

#    - name: "SSH | Copy SSH keys"
#      copy:
#        dest: "{{ ansible_user_dir }}/.ssh/{{ item.key }}"
#        content: "{{ item.value }}"
#        mode: "0600"
#      no_log: false  # Temporarily disable no_log for debugging
#      loop: "{{ ssh_key | default({}) | dict2items }}"
#      tags:
#        - mac-minimal
#        - mac-full
#        - linux

    - name: Start SSH agent
      shell: eval $(ssh-agent -s)
      register: ssh_agent_output
      tags:
        - mac-minimal
        - mac-full
        - linux

# Clone the configs repo
    - name: Clone the .dotfiles repository into a hidden directory
      git:
        repo: 'git@github.com:suyashbhawsar/.dotfiles.git'
        dest: '{{ ansible_user_dir }}/.dotfiles'
        accept_hostkey: yes
        update: yes
      tags:
        - mac-minimal
        - mac-full
        - linux

    - name: Include vars file from the cloned repo
      include_vars:
        file: "{{ ansible_user_dir }}/.dotfiles/gcloud/gcloud_credentials.yml"
      tags:
        - mac-minimal
        - mac-full
        - linux


## GNU Stow
    - name: "MacOS | Install GNU Stow"
      homebrew:
        name: stow
        state: present
      tags:
        - mac-minimal
        - mac-full
  
    - name: "Debian | Install GNU Stow"
      apt:
        name: stow
        state: present
      become: true
      tags:
        - linux
   
  
## 1Password
    - name: "MacOS | Install 1Password and 1Password CLI"
      homebrew:
        name: "{{ item }}"
        state: present
      with_items:
        - 1password
        - 1password-cli
      tags:
        - mac-full

    
# ###gcloud
    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - gnupg
          - curl
        state: present
      tags:
        - mac-minimal
        - mac-full
        - linux
        
    - name: Add Google Cloud public GPG key
      shell: curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
      become: true
      tags:
        - mac-minimal
        - mac-full
        - linux
      

    - name: Add Google Cloud SDK repository
      copy:
        content: "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main\n"
        dest: /etc/apt/sources.list.d/google-cloud-sdk.list
        owner: root
        group: root
        mode: '0644'
      tags:
        - mac-minimal
        - mac-full
        - linux

    - name: Update apt package list
      apt:
        update_cache: yes
      tags:
        - mac-minimal
        - mac-full
        - linux

    - name: Install Google Cloud SDK
      apt:
        name: google-cloud-cli
        state: present
      tags:
        - mac-minimal
        - mac-full
        - linux

    - name: "SSH | Copy SSH keys"
      copy:
        dest: "{{ ansible_user_dir }}/.ssh/{{ ssh_key_item.key }}"
        content: "{{ ssh_key_item.value }}"
        mode: "0600"
      no_log: true
      loop_control:
        loop_var: ssh_key_item
      with_items: "{{ ssh | default({}) | dict2items }}"
      tags:
        - mac-minimal
        - mac-full
        - linux
        
    # - name: gcloud compute SSH
    #   command: gcloud compute ssh
    #   become: false
    #   tags:
    #     - mac-minimal
    #     - mac-full
    #     - linux

    - name: Copy service-account-key-file to .ssh directory
      copy:
        dest: "{{ ansible_user_dir }}/.ssh/service-account-key-file.json"
        content: "{{ service-account-key-file }}"
        mode: '0600'
      no_log: false
      tags:
        - mac-minimal
        - mac-full
        - linux


    - name: Authenticate with service account
      command: gcloud auth activate-service-account --key-file "{{ ansible_user_dir }}/.ssh/service-account-key-file.json"
      become: false
      tags:
        - mac-minimal
        - mac-full
        - linux

    # - name: Configure gcloud compute SSH
    #   command: gcloud compute config-ssh
    #   become: false
    #   tags:
    #     - mac-minimal
    #     - mac-full
    #     - linux


## kitty
    - name: "MacOS | Install Kitty emulator"
      homebrew:
        name: kitty
        state: present
      tags:
        - mac-full


## neovim
    - name: "MacOS | Install Neovim & its Dependencies"
      homebrew:
        name: "{{ item }}"
        state: present
      with_items:
        - libtool
        - ansible-lint
        - ripgrep
        - lua
        - luarocks
        - luajit
        - neovim
      tags:
        - mac-minimal
        - mac-full

    - name: "Debian | Install Neovim & its Dependencies"
      ansible.builtin.apt:
        name:
          - cmake
          - curl
          - pkg-config
          - libtool
          - unzip
          - ansible-lint
          - ripgrep
          - lua5.1
          - luarocks
          - luajit
          - neovim
        state: present
      become: true
      tags:
        - linux

    - name: "Neovim | Config folder"
      ansible.builtin.file:
        mode: "0755"
        path: "{{ ansible_user_dir }}/.config/nvim"
        state: directory
      tags:
        - mac-minimal
        - mac-full
        - linux


##obsidian
    - name: "MacOS | Install Obsidian"
      homebrew:
        name: obsidian
        state: present
      tags:
        - mac-minimal
        - mac-full


## tmux
    - name: "MacOS | Install tmux"
      homebrew:
        name: tmux
        state: present
      tags:
        - mac-minimal
        - mac-full

    - name: "Debian | Install tmux"
      ansible.builtin.apt:
        name: tmux
        state: present
      become: true
      tags:
        - linux

    - name: "Tmux | Configure tmux using Stow"
      ansible.builtin.command:
        cmd: "stow -d {{ ansible_user_dir }}/.dotfiles -t {{ ansible_env.HOME }} tmux"
      tags:
        - mac-minimal
        - mac-full
        - linux

#    - name: "Tmux | Configure tmux"
#      ansible.builtin.copy:
#        src: "{{ ansible_user_dir }}/.dotfiles/tmux/tmux.conf"
#        dest: "{{ ansible_user_dir }}/.config/"
#        mode: "0644"
#        directory_mode: "0755"
#        force: true
#      tags:
#        - mac-minimal
#        - mac-full
#        - linux

## zsh
    - name: "MacOS | Install ZSH"
      homebrew:
        name: "{{ item }}"
        state: present
      loop:
        - zsh
      tags:
        - mac-minimal
        - mac-full

    - name: "Debian | Install Zsh"
      apt:
        name: zsh
        state: present
      become: true
      tags:
        - linux

    # - name: Remove existing .zshrc file
    #   file:
    #     path: "{{ ansible_env.HOME }}/.zshrc"
    #     state: absent
    #   tags:
    #     - mac-minimal
    #     - mac-full
    #     - linux

    # - name: "Zsh | Configure .zshrc using Stow"
    #   ansible.builtin.command:
    #     cmd: "stow -d {{ ansible_user_dir }}/.dotfiles -t {{ ansible_env.HOME }} zsh"
    #   tags:
    #     - mac-minimal
    #     - mac-full
    #     - linux

#    - name: "Zsh | Configure .zshrc"
#      ansible.builtin.copy:
#        src: "{{ ansible_user_dir }}/.dotfiles/zsh/.zshrc"
#        dest: "{{ ansible_user_dir }}/"
#        force: true
#      tags:
#        - mac-minimal
#        - mac-full
#        - linux

    - name: "Zsh | Detect oh-my-zsh"
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.oh-my-zsh"
      register: ohmyzsh
      tags:
        - mac-minimal
        - mac-full
        - linux

    - name: "Zsh | Install oh-my-zsh if not installed"
      when: not ohmyzsh.stat.exists
      tags:
        - mac-minimal
        - mac-full
        - linux
      block:
        - name: "Zsh | Download oh-my-zsh Install Script"
          ansible.builtin.get_url:
            url: "https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh"
            dest: "{{ ansible_user_dir }}/oh-my-zsh.install.sh"
            mode: "0755"

        - name: "Zsh | Run oh-my-zsh Install Script"
          ansible.builtin.command:
            cmd: "sh {{ ansible_user_dir }}/oh-my-zsh.install.sh"

        - name: "Zsh | Cleanup Oh My Zsh Install Script"
          ansible.builtin.file:
            path: "{{ ansible_env.HOME }}/oh-my-zsh.install.sh"
            state: absent

    - name: Clone zsh-syntax-highlighting repository
      ansible.builtin.git:
        repo: https://github.com/zsh-users/zsh-syntax-highlighting.git
        dest: "{{ ansible_user_dir }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
        depth: 1
      tags:
        - mac-minimal
        - mac-full
        - linux

    # - name: Add zsh-syntax-highlighting to .zshrc
    #   ansible.builtin.lineinfile:
    #     dest: "{{ ansible_user_dir }}/.zshrc"
    #     line: "source {{ ansible_user_dir }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
    #   tags:
    #     - mac-minimal
    #     - mac-full
    #     - linux

    - name: Clone zsh-autosuggestions repository
      ansible.builtin.git:
        repo: https://github.com/zsh-users/zsh-autosuggestions.git
        dest: "{{ ansible_user_dir }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
        depth: 1
      tags:
        - mac-minimal
        - mac-full
        - linux

    # - name: Add zsh-autosuggestions to .zshrc
    #   ansible.builtin.lineinfile:
    #     dest: "{{ ansible_user_dir }}/.zshrc"
    #     line: "source {{ ansible_user_dir }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh"
    #   tags:
    #     - mac-minimal
    #     - mac-full
    #     - linux

    - name: "Zsh | Update .zshrc for all users"
      shell: |
        source ~/.zshrc
      args:
        executable: /bin/zsh
      tags:
        - mac-minimal
        - mac-full
        - linux
        
    - name: Remove existing .zshrc file
      file:
        path: "{{ ansible_env.HOME }}/.zshrc"
        state: absent
      tags:
        - mac-minimal
        - mac-full
        - linux

    - name: "Zsh | Configure .zshrc using Stow"
      ansible.builtin.command:
        cmd: "stow -d {{ ansible_user_dir }}/.dotfiles -t {{ ansible_env.HOME }} zsh"
      tags:
        - mac-minimal
        - mac-full
        - linux
